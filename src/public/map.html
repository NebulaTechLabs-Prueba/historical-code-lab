<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo</title>
    <style>
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; }
        .gm-style-iw-button { display: none !important; }
        .gm-style-iw-d { overflow: auto !important; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        let map;
        let userMarker, destinationMarker;
        let routePolyline;
        let infoWindow;
        let wixPage;
        let autocompleteService;
        let geocoder;

        // 1. Escucha los mensajes desde la p치gina de Wix
        window.addEventListener("message", (event) => {
            if (!event.data) return;
            if (!wixPage) wixPage = event.source;

            const { action, apiKey, lat, lng, polyline, info, destino, input, sourceId } = event.data;

            switch (action) {
                case "centrarEnUbicacion":
                    centrarEnUbicacion(lat, lng);
                    break;
                case "dibujarRutaConInfo":
                    dibujarRutaConInfo({ polyline, info, destino });
                    break;
                case "limpiarMapa":
                    limpiarMapa();
                    break;
                case "getAutocompletePredictions":
                    getAutocompletePredictions(input, sourceId);
                    break;
            }
            
            if (apiKey && !window.google) {
                cargarScriptGoogleMaps(apiKey);
            }
        });

        // 2. Carga el script de Google Maps
        function cargarScriptGoogleMaps(apiKey) {
            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=geometry,places`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        // 3. Inicializa el mapa y los objetos reutilizables
        window.initMap = function () {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 40.416775, lng: -3.703790 },
                zoom: 12,
            });

            routePolyline = new google.maps.Polyline({ strokeColor: '#0000FF', strokeOpacity: 0.9, strokeWeight: 6, map: map });
            destinationMarker = new google.maps.Marker({ map: map });
            infoWindow = new google.maps.InfoWindow();
            autocompleteService = new google.maps.places.AutocompleteService();
            geocoder = new google.maps.Geocoder();

            map.addListener("click", (e) => {
                if (wixPage) {
                    wixPage.postMessage({ action: "destinoSeleccionado", lat: e.latLng.lat(), lng: e.latLng.lng() }, "*");
                }
            });
        };

        // 4. Centra el mapa en la ubicaci칩n del usuario
        function centrarEnUbicacion(lat, lng) {
            if (!map) return;
            const posicion = { lat, lng };
            map.setCenter(posicion);
            map.setZoom(15);
            if (!userMarker) {
                userMarker = new google.maps.Marker({ position: posicion, map: map, title: "Tu ubicaci칩n" });
            } else {
                userMarker.setPosition(posicion);
            }
        }

        // 5. Dibuja la ruta y muestra la informaci칩n
        function dibujarRutaConInfo(data) {
            const { polyline, info, destino } = data;
            if (!map || !routePolyline || !polyline) return;
            
            const path = google.maps.geometry.encoding.decodePath(polyline);
            routePolyline.setPath(path);

            const destinoLatLng = new google.maps.LatLng(destino.lat, destino.lng);
            destinationMarker.setPosition(destinoLatLng);
            destinationMarker.setTitle("Destino");

            infoWindow.setContent(info);
            infoWindow.open(map, destinationMarker);
        }

        // 6. Limpia la ruta y marcadores del mapa
        function limpiarMapa() {
            if (routePolyline) routePolyline.setPath([]);
            if (destinationMarker) destinationMarker.setPosition(null);
            if (infoWindow) infoWindow.close();
        }

        // 7. Obtiene predicciones de autocompletado
        function getAutocompletePredictions(input, sourceId) {
            if (!autocompleteService || !input) {
                wixPage.postMessage({ action: "autocompleteResults", predictions: [], sourceId: sourceId }, "*");
                return;
            }
            autocompleteService.getPlacePredictions({ input: input }, (predictions, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                    const results = predictions.map(p => ({ description: p.description, place_id: p.place_id }));
                    wixPage.postMessage({ action: "autocompleteResults", predictions: results, sourceId: sourceId }, "*");
                } else {
                    wixPage.postMessage({ action: "autocompleteResults", predictions: [], sourceId: sourceId }, "*");
                }
            });
        }

    </script>
</body>
</html>