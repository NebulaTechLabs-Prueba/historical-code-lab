<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo</title>
    <style>
        html, body, #map { height: 100%; width: 100%; margin: 0; padding: 0; }
        .gm-style-iw-button { display: none !important; }
        .gm-style-iw-d { overflow: auto !important; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        let map;
        let userMarker;
        let routePolylines = []; // Array para múltiples polilíneas
        let routeMarkers = [];   // Array para múltiples marcadores
        let infoWindow;
        let wixPage;
        let autocompleteService;
        let geocoder;

        // Colores para los diferentes tramos de la ruta
        const routeColors = ['#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#A133FF', '#33FFA1'];

        // 1. Escucha los mensajes desde la página de Wix
        window.addEventListener("message", (event) => {
            if (!event.data) return;
            if (!wixPage) wixPage = event.source;

            const { action, apiKey, lat, lng, legs, info, sourceId } = event.data;

            switch (action) {
                case "centrarEnUbicacion":
                    centrarEnUbicacion(lat, lng);
                    break;
                case "dibujarRutaConInfo":
                    dibujarRutaConInfo({ legs, info });
                    break;
                case "limpiarMapa":
                    limpiarMapa();
                    break;
                case "getAutocompletePredictions":
                    getAutocompletePredictions(input, sourceId);
                    break;
            }
            
            if (apiKey && !window.google) {
                cargarScriptGoogleMaps(apiKey);
            }
        });

        // 2. Carga el script de Google Maps
        function cargarScriptGoogleMaps(apiKey) {
            const script = document.createElement("script");
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&libraries=geometry,places`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        // 3. Inicializa el mapa y los objetos reutilizables
        window.initMap = function () {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 10.4806, lng: -66.9036 }, // Centrado en Caracas
                zoom: 12,
            });

            infoWindow = new google.maps.InfoWindow();
            autocompleteService = new google.maps.places.AutocompleteService();
            geocoder = new google.maps.Geocoder();

            map.addListener("click", (e) => {
                if (wixPage) {
                    wixPage.postMessage({ action: "destinoSeleccionado", lat: e.latLng.lat(), lng: e.latLng.lng() }, "*");
                }
            });
        };

        // 4. Centra el mapa en la ubicación del usuario
        function centrarEnUbicacion(lat, lng) {
            if (!map) return;
            const posicion = { lat, lng };
            map.setCenter(posicion);
            map.setZoom(15);
            if (!userMarker) {
                userMarker = new google.maps.Marker({ position: posicion, map: map, title: "Tu ubicación" });
            } else {
                userMarker.setPosition(posicion);
            }
        }

        // 5. Dibuja la ruta con múltiples colores y marcadores
        function dibujarRutaConInfo(data) {
            const { legs, info } = data;
            if (!map || !legs || legs.length === 0) return;

            limpiarMapa(); // Limpia cualquier ruta anterior

            const bounds = new google.maps.LatLngBounds();
            let cumulativeDistance = 0;
            let cumulativeDuration = 0;

            legs.forEach((leg, index) => {
                let legPath = []; // Array para las coordenadas de este tramo
                cumulativeDistance += leg.distance.value;
                cumulativeDuration += leg.duration.value;

                // Iteramos sobre los pasos (steps) de cada tramo (leg)
                leg.steps.forEach(step => {
                    const stepPath = google.maps.geometry.encoding.decodePath(step.polyline.points);
                    legPath = legPath.concat(stepPath);
                });

                const polyline = new google.maps.Polyline({
                    path: legPath,
                    strokeColor: routeColors[index % routeColors.length],
                    strokeOpacity: 0.9,
                    strokeWeight: 6,
                    map: map
                });
                routePolylines.push(polyline);

                legPath.forEach(latLng => bounds.extend(latLng));

                const endMarker = new google.maps.Marker({
                    position: leg.end_location,
                    map: map,
                });
                routeMarkers.push(endMarker);

                // Preparamos el contenido del InfoWindow para este marcador
                const formattedCumulativeDistance = `${(cumulativeDistance / 1000).toFixed(1)} km`;
                const formattedCumulativeDuration = `${Math.round(cumulativeDuration / 60)} mins`;
                const shortAddress = leg.end_address.split(',')[0];

                const infoContent = `<strong>Parada ${index + 1}</strong><br>` +
                                  `<b>Ubicación:</b> ${shortAddress}<br>` +
                                  `<b>Tramo:</b> ${leg.distance.text}, ${leg.duration.text}<br>` +
                                  `<b>Total Acumulado:</b> ${formattedCumulativeDistance}, ${formattedCumulativeDuration}`;

                // Añadimos un listener para mostrar el InfoWindow al hacer clic
                endMarker.addListener('click', () => {
                    infoWindow.setContent(infoContent);
                    infoWindow.open(map, endMarker);
                });
            });

            map.fitBounds(bounds); // Ajusta el zoom del mapa para mostrar toda la ruta
        }

        // 6. Limpia todas las rutas y marcadores del mapa
        function limpiarMapa() {
            routePolylines.forEach(p => p.setMap(null));
            routePolylines = [];
            routeMarkers.forEach(m => m.setMap(null));
            routeMarkers = [];
            if (infoWindow) infoWindow.close();
        }

        // 7. Obtiene predicciones de autocompletado
        function getAutocompletePredictions(input, sourceId) {
            if (!autocompleteService || !input) {
                wixPage.postMessage({ action: "autocompleteResults", predictions: [], sourceId: sourceId }, "*");
                return;
            }
            autocompleteService.getPlacePredictions({ input: input }, (predictions, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                    const results = predictions.map(p => ({ description: p.description, place_id: p.place_id }));
                    wixPage.postMessage({ action: "autocompleteResults", predictions: results, sourceId: sourceId }, "*");
                } else {
                    wixPage.postMessage({ action: "autocompleteResults", predictions: [], sourceId: sourceId }, "*");
                }
            });
        }

    </script>
</body>
</html>